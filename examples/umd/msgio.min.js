!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).msgio={})}(this,(function(e){"use strict";function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,d(r.key),r)}}function r(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function o(e,t,n){return(t=d(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&s(e,t)}function a(e){return a=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},a(e)}function s(e,t){return s=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},s(e,t)}function c(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function u(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=a(e);if(t){var o=a(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return function(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return c(e)}(this,n)}}function f(e){return function(e){if(Array.isArray(e))return l(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return l(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return l(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function l(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function d(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}let p=()=>({events:{},emit(e,...t){let n=this.events[e]||[];for(let e=0,r=n.length;e<r;e++)n[e](...t)},on(e,t){return this.events[e]?.push(t)||(this.events[e]=[t]),()=>{this.events[e]=this.events[e]?.filter((e=>t!==e))}}});var v="application/msgio+json",h=r((function e(n){var r=this;t(this,e),o(this,"emitter",p()),o(this,"origin",window.location.origin),o(this,"socketId","none"),o(this,"sendPacket",(function(e,t){r.receiver.target.postMessage({mime:v,type:e,socket:"CONNECT"===e?r.socketId:void 0,body:t},r.receiver.origin)})),o(this,"isValidEvent",(function(e){var t=e.origin,n=e.data,o=n.mime,i=n.type,a=n.socket;return t===r.receiver.origin&&(o===v&&("CONNECT"===i||a===r.socketId))})),o(this,"on",(function(e,t){r.emitter.on(e,t)})),this.receiver=n}));var m=function(e){var t=document.createElement("a");t.href=e;var n=t.protocol.length>4?t.protocol:window.location.protocol,r=t.host.length>0?"80"===t.port||"443"===t.port?t.hostname:t.host:window.location.host;return t.origin||"".concat(n,"//").concat(r)},y=function(){return"".concat(((e=21)=>crypto.getRandomValues(new Uint8Array(e)).reduce(((e,t)=>e+((t&=63)<36?t.toString(36):t<62?(t-26).toString(36).toUpperCase():t>62?"-":"_")),""))(),"<msgio>")},g=function(e){return e.data.type},E=function(e){return e.data.body},w=r((function e(n){var r=this;t(this,e),o(this,"emitter",p()),o(this,"isValidEvent",(function(e){var t=e.origin,n=e.data,o=n.mime,i=n.socket;return t===r.connection.receiver.origin&&(o===v&&i===r.id)})),o(this,"sendPacket",(function(e,t){var n=r.connection.receiver,o=n.target,i=n.origin;o.postMessage({mime:v,type:e,socket:r.id,body:t},i)})),o(this,"onEvent",(function(e){if(r.isValidEvent(e)&&"SOCKET_EVENT"===g(e)){var t=E(e),n=t.event,o=t.payload;r.emitter.emit(n,o)}})),o(this,"on",(function(e,t){r.emitter.on(e,t)})),o(this,"emit",(function(e,t){r.sendPacket("SOCKET_EVENT",{event:e,payload:t})})),o(this,"func",(function(e,t){if("function"!=typeof t)throw new Error("The object supplied to 'function' must be a function!<msgio>");r.functionRegistry.set(e,t)})),o(this,"onCallRequest",(function(e){if(r.isValidEvent(e)&&"SOCKET_CALL_REQUEST"===g(e)){var t=E(e),n=t.callId,o=t.fname,i=t.args,a=function(e){r.sendPacket("SOCKET_CALL_RESPONSE",{callId:n,fname:o,payload:e})},s=function(e){return a({error:!0,result:(t=e,{name:t.name,message:t.message})});var t};if(r.functionRegistry.has(o))try{var c=r.functionRegistry.get(o).apply(void 0,f(i));Promise.resolve(c).then((function(e){return a({error:!1,result:e})})).catch(s)}catch(e){s(e)}else s(new ReferenceError("".concat(o," is not defined!<msgio>")))}})),o(this,"onCallResponse",(function(e){if(r.isValidEvent(e)&&"SOCKET_CALL_RESPONSE"===g(e)){var t=E(e),n=t.callId,o=t.payload,i=o.error,a=o.result;if(r.callRegistry.has(n)){var s,c,u,f,l=r.callRegistry.get(n),d=l.resolve,p=l.reject;i?p((c=(s=a).name,u=s.message,f={Error:Error,EvalError:EvalError,RangeError:RangeError,ReferenceError:ReferenceError,SyntaxError:SyntaxError,TypeError:TypeError,URIError:URIError},c in f?new f[c](u):new Error("Unknown Error type!<msgio>"))):d(a),r.callRegistry.delete(n)}}})),o(this,"call",(function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),o=1;o<t;o++)n[o-1]=arguments[o];var i=y();return r.sendPacket("SOCKET_CALL_REQUEST",{callId:i,fname:e,args:n}),new Promise((function(t,o){r.callRegistry.set(i,{callId:i,fname:e,args:n,resolve:t,reject:o})}))})),this.connection=n,this.id=this.connection.socketId,this.functionRegistry=new Map,this.callRegistry=new Map,window.addEventListener("message",this.onEvent),window.addEventListener("message",this.onCallRequest),window.addEventListener("message",this.onCallResponse)})),b=function(e){i(a,e);var n=u(a);function a(e){var r;if(t(this,a),"IFRAME"!==e.tagName||!e.contentWindow)throw new Error("The DOM Node supplied is not a valid iframe node!<msgio>");return o(c(r=n.call(this,{target:e.contentWindow,origin:m(e.src)})),"desiredSocketId",y()),o(c(r),"onConnect",(function(e){r.isValidEvent(e)&&("CONNECT"===g(e)&&e.data.body===r.desiredSocketId&&(r.socketId=r.desiredSocketId,r.desiredSocketId="verified",r.emitter.emit("connect",new w(c(r))),window.removeEventListener("message",r.onConnect)))})),o(c(r),"onResize",(function(e){if(r.isValidEvent(e)&&"RESIZE"===g(e)){var t=e.data.body,n=t.width,o=t.height;r.dom.width=n,r.dom.height=o}})),r.dom=e,window.addEventListener("message",r.onConnect),window.addEventListener("message",r.onResize),r.sendPacket("CONNECT",r.desiredSocketId),r}return r(a)}(h),R=function(e){i(a,e);var n=u(a);function a(e){var r;t(this,a);var i=e.host;return o(c(r=n.call(this,{target:window.parent,origin:m(i)})),"onConnect",(function(e){if(r.isValidEvent(e)&&"CONNECT"===g(e)){var t=E(e);t&&(r.socketId=t,r.sendPacket("CONNECT",r.socketId),r.emitter.emit("connect",new w(c(r))),window.removeEventListener("message",r.onConnect))}})),o(c(r),"resize",(function(e){r.sendPacket("RESIZE",e)})),r.option=e,window.addEventListener("message",r.onConnect),r}return r(a)}(h);e.Guest=R,e.Iframe=b}));
//# sourceMappingURL=msgio.min.js.map
